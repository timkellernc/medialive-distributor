<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Distribution Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .status-badge { font-size: 0.85em; padding: 0.35em 0.65em; }
        .status-active { background-color: #28a745; }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #6c757d; }
        .status-error { background-color: #dc3545; }
        .status-reconnecting { background-color: #ffc107; color: #000; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); margin-bottom: 1.5rem; }
        .input-card:hover { box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); transition: box-shadow 0.3s; }
        .protocol-badge { font-size: 0.75em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-broadcast-tower"></i> Stream Distribution Manager
            </span>
            <span class="text-white">
                <span id="system-status" class="badge bg-success">System Healthy</span>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Inputs</h5>
                        <h2 id="total-inputs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total Outputs</h5>
                        <h2 id="total-outputs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Active Outputs</h5>
                        <h2 id="active-outputs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">CPU Usage</h5>
                        <h2 id="cpu-usage">0%</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inputs Section -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Input Streams</h3>
                    <button class="btn btn-primary" onclick="showAddInputModal()">
                        <i class="fas fa-plus"></i> Add Input
                    </button>
                </div>
                <div id="inputs-container" class="row">
                    <!-- Inputs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Input Modal -->
    <div class="modal fade" id="addInputModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Input</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addInputForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="input-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">UDP Port (optional)</label>
                            <input type="number" class="form-control" id="input-port" min="5000" max="5100">
                            <small class="form-text text-muted">Leave empty for auto-assignment</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createInput()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_KEY = 'your-secret-api-key-change-in-production';
        const API_BASE = '/api';

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'X-API-Key': API_KEY,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);
            
            const response = await fetch(API_BASE + endpoint, options);
            if (!response.ok) throw new Error(await response.text());
            return response.json();
        }

        async function loadSystemStatus() {
            try {
                const status = await apiRequest('/system/status');
                document.getElementById('total-inputs').textContent = status.inputs_count;
                document.getElementById('total-outputs').textContent = status.outputs_count;
                document.getElementById('active-outputs').textContent = status.active_outputs;
                document.getElementById('cpu-usage').textContent = status.cpu_percent.toFixed(1) + '%';
                
                const statusBadge = document.getElementById('system-status');
                statusBadge.textContent = status.healthy ? 'System Healthy' : 'System Issues';
                statusBadge.className = status.healthy ? 'badge bg-success' : 'badge bg-danger';
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        async function loadInputs() {
            try {
                const inputs = await apiRequest('/inputs');
                const container = document.getElementById('inputs-container');
                container.innerHTML = '';
                
                inputs.forEach(input => {
                    container.innerHTML += `
                        <div class="col-md-4">
                            <div class="card input-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h5 class="card-title">${input.name}</h5>
                                        <span class="badge status-badge status-${input.status}">${input.status}</span>
                                    </div>
                                    <p class="card-text">
                                        <small class="text-muted">
                                            UDP Port: ${input.udp_port}<br>
                                            SRT Port: ${input.srt_port}<br>
                                            Outputs: ${input.output_count}
                                        </small>
                                    </p>
                                    <button class="btn btn-sm btn-primary" onclick="viewInput(${input.id})">
                                        View Details
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteInput(${input.id})">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error loading inputs:', error);
            }
        }

        function showAddInputModal() {
            new bootstrap.Modal(document.getElementById('addInputModal')).show();
        }

        async function createInput() {
            const name = document.getElementById('input-name').value;
            const port = document.getElementById('input-port').value;
            
            try {
                const data = { name };
                if (port) data.udp_port = parseInt(port);
                
                await apiRequest('/inputs', 'POST', data);
                bootstrap.Modal.getInstance(document.getElementById('addInputModal')).hide();
                document.getElementById('addInputForm').reset();
                loadInputs();
                loadSystemStatus();
            } catch (error) {
                alert('Error creating input: ' + error.message);
            }
        }

        async function deleteInput(inputId) {
            if (!confirm('Are you sure you want to delete this input and all its outputs?')) return;
            
            try {
                await apiRequest(`/inputs/${inputId}`, 'DELETE');
                loadInputs();
                loadSystemStatus();
            } catch (error) {
                alert('Error deleting input: ' + error.message);
            }
        }

        function viewInput(inputId) {
            // TODO: Implement detailed view
            alert('Detailed view for input ' + inputId + ' - To be implemented');
        }

        // Initial load
        loadSystemStatus();
        loadInputs();
        
        // Refresh every 5 seconds
        setInterval(() => {
            loadSystemStatus();
            loadInputs();
        }, 5000);
    </script>
</body>
</html>
