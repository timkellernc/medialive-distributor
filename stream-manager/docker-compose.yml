version: '3.8'

services:
  # Application Container
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stream-manager-app
    restart: always
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=${DATABASE_URL:-sqlite:////data/stream_manager.db}
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - API_KEY=${API_KEY:-your-secret-api-key-change-in-production}
      - MEDIAMTX_CONFIG_PATH=/config/mediamtx.yml
      - MEDIAMTX_API_URL=http://mediamtx:9997
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=8080
      - DEFAULT_RECONNECT_DELAY=${DEFAULT_RECONNECT_DELAY:-5}
      - MAX_RECONNECT_ATTEMPTS=${MAX_RECONNECT_ATTEMPTS:-0}
      - UDP_PORT_RANGE_START=${UDP_PORT_RANGE_START:-5000}
      - UDP_PORT_RANGE_END=${UDP_PORT_RANGE_END:-5100}
      - SRT_PORT_RANGE_START=${SRT_PORT_RANGE_START:-8890}
    volumes:
      - app-data:/data
      - ./config:/config
      - app-logs:/app/logs
    depends_on:
      mediamtx:
        condition: service_healthy
    networks:
      - stream-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MediaMTX Container
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: stream-manager-mediamtx
    restart: always
    environment:
      - MTX_LOGLEVEL=${MTX_LOGLEVEL:-info}
    ports:
      # API port
      - "9997:9997"
      # RTSP port
      - "8554:8554"
      # UDP input ports (5000-5100)
      - "5000-5100:5000-5100/udp"
      # SRT ports (8890-8990)
      - "8890-8990:8890-8990/udp"
    volumes:
      - ./config:/config
    command: /config/mediamtx.yml
    networks:
      - stream-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9997/v3/config/get"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 30s

  # PostgreSQL Database (optional, comment out to use SQLite)
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: stream-manager-db
  #   restart: always
  #   environment:
  #     - POSTGRES_USER=${POSTGRES_USER:-streamuser}
  #     - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
  #     - POSTGRES_DB=${POSTGRES_DB:-streamdb}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - stream-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-streamuser}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

volumes:
  app-data:
    driver: local
  mediamtx-config:
    driver: local
  app-logs:
    driver: local
  # postgres-data:
  #   driver: local

networks:
  stream-network:
    driver: bridge
